<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Random Survey</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <script>
    // 1️⃣ Firebase 初始化
    const firebaseConfig = {
      apiKey: "AIzaSyDwNLmo8CbUy_yz8Phay5ugxBVnsTWxrtc",
      authDomain: "random-survey-abe86.firebaseapp.com",
      projectId: "random-survey-abe86",
      storageBucket: "random-survey-abe86.firebasestorage.app",
      messagingSenderId: "586364937583",
      appId: "1:586364937583:web:1b95dbb866c3305230f49a",
      measurementId: "G-SC7Q6VY1RS"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const perGroupLimit = 2; // 測試模式
    const urls = [
      'https://www.surveycake.com/s/PwOV2',
      'https://www.surveycake.com/s/oN0Q3',
      'https://www.surveycake.com/s/e2m86',
      'https://www.surveycake.com/s/NNY2L'
    ];

    async function assignGroup() {
      const snapshot = await db.collection('surveyGroups').get();
      let groups = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        // 只加入 count 未滿的 group
        if (data.count < perGroupLimit) {
          groups.push({id: doc.id, ...data});
        }
      });

      if (groups.length === 0) {
        document.body.innerHTML = "<h2>感謝參與，本研究已額滿！</h2>";
        return;
      }

      let assigned = false;
      while (!assigned && groups.length > 0) {
        // 隨機選一組
        const chosenIndex = Math.floor(Math.random() * groups.length);
        const chosen = groups[chosenIndex];
        const groupRef = db.collection('surveyGroups').doc(chosen.id);

        try {
          // Transaction 增加 count
          await db.runTransaction(async (t) => {
            const doc = await t.get(groupRef);
            const currentCount = doc.data().count;
            if (currentCount >= perGroupLimit) throw "Full";
            t.update(groupRef, {count: currentCount + 1});
          });

          // 導向對應問卷
          const index = parseInt(chosen.groupName, 10) - 1;
          window.location.href = urls[index];
          assigned = true;

        } catch (err) {
          if (err === "Full") {
            // 移除已滿的 group，繼續 while 隨機選剩下的
            groups.splice(chosenIndex, 1);
          } else {
            console.error(err);
            document.body.innerHTML = "<h2>發生錯誤，請稍後再試。</h2>";
            return;
          }
        }
      }

      if (!assigned) {
        document.body.innerHTML = "<h2>感謝參與，本研究已額滿！</h2>";
      }
    }

    assignGroup();
  </script>
</body>
</html>
