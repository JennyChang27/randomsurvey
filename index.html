<body>
  <div id="message">倒數 3 秒後自動分派…</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // 🔧 你的 Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const groups = ["A", "B", "C", "D"];
    const perGroupLimit = 2;

    async function assignGroup() {
      // 讀取所有組別
      const available = [];
      for (let g of groups) {
        const ref = doc(db, "surveyGroups", g);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const data = snap.data();
          if (data.count < perGroupLimit) {
            available.push({ ref, data });
          }
        }
      }

      if (available.length === 0) {
        document.getElementById("message").innerText = "感謝參與，本研究已額滿！";
        return;
      }

      // 隨機挑一組
      const choice = available[Math.floor(Math.random() * available.length)];
      await updateDoc(choice.ref, {
        count: choice.data.count + 1
      });

      // 跳轉
      window.location.href = choice.data.url;
    }

    // ⏳ 倒數 3 秒，才真正觸發 assignGroup()
    let count = 3;
    const interval = setInterval(() => {
      document.getElementById("message").innerText = `倒數 ${count} 秒後自動分派…`;
      count--;
      if (count < 0) {
        clearInterval(interval);
        assignGroup();
      }
    }, 1000);
  </script>
</body>
