<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Random Survey</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <h2 id="message">loading...</h2>

  <script>
    // 1ï¸âƒ£ Firebase åˆå§‹åŒ–
    const firebaseConfig = {
      apiKey: "AIzaSyDwNLmo8CbUy_yz8Phay5ugxBVnsTWxrtc",
      authDomain: "random-survey-abe86.firebaseapp.com",
      projectId: "random-survey-abe86",
      storageBucket: "random-survey-abe86.firebasestorage.app",
      messagingSenderId: "586364937583",
      appId: "1:586364937583:web:1b95dbb866c3305230f49a",
      measurementId: "G-SC7Q6VY1RS"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const perGroupLimit = 50; // æ¸¬è©¦æ¨¡å¼
    const urls = {
      "A": "https://www.surveycake.com/s/PwOV2",
      "B": "https://www.surveycake.com/s/oN0Q3",
      "C": "https://www.surveycake.com/s/e2m86",
      "D": "https://www.surveycake.com/s/NNY2L"
    };

    // âœ… å€’æ•¸ + åˆ†æ´¾
    function startCountdown() {
      let count = 3;
      const msg = document.getElementById("message");
      msg.innerText = `Auto-assigning in ${count} secondsâ€¦`;

      const interval = setInterval(() => {
        count--;
        if (count > 0) {
          msg.innerText = `Auto-assigning in ${count} secondsâ€¦`;
        } else {
          clearInterval(interval);
          assignGroup();
        }
      }, 1000);
    }

    // âœ… ç¢ºä¿åªæœ‰ã€ŒçœŸæ­£é€²åˆ°ç¶²é ã€æ‰è§¸ç™¼
    function initWhenVisible() {
      if (document.visibilityState === "visible") {
        startCountdown();
      } else {
        document.addEventListener("visibilitychange", () => {
          if (document.visibilityState === "visible") {
            startCountdown();
          }
        }, { once: true });
      }
    }

    // âœ… åˆ†æ´¾é‚è¼¯
    async function assignGroup() {
      try {
        const snapshot = await db.collection('surveyGroups').get();
        const groups = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.count < perGroupLimit) {
            groups.push({id: doc.id, ...data});
          }
        });

        if (groups.length === 0) {
          document.body.innerHTML = "<h2>Thank you for your interest, this study is now full!</h2>";
          return;
        }

        const chosen = groups[Math.floor(Math.random() * groups.length)];
        const groupRef = db.collection('surveyGroups').doc(chosen.id);

        await db.runTransaction(async (t) => {
          const doc = await t.get(groupRef);
          const currentCount = doc.data().count;
          if (currentCount >= perGroupLimit) throw "Full";
          t.update(groupRef, {count: currentCount + 1});
        });

        // æ ¹æ“š groupName è½‰è·³
        window.location.href = urls[chosen.groupName];
      } catch (err) {
        if (err === "Full") {
          document.body.innerHTML = "<h2>Thank you for your interest, this study is now full!</h2>";
        } else {
          document.body.innerHTML = "<h2>Something went wrong, please try again later.</h2>";
          console.error(err);
        }
      }
    }

    // ðŸš€ å•Ÿå‹•
    initWhenVisible();
  </script>
</body>
</html>
