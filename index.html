<body>
  <div id="message">å€’æ•¸ 3 ç§’å¾Œè‡ªå‹•åˆ†æ´¾â€¦</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ğŸ”§ ä½ çš„ Firebase config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const groups = ["A", "B", "C", "D"];
    const perGroupLimit = 2;

    async function assignGroup() {
      // è®€å–æ‰€æœ‰çµ„åˆ¥
      const available = [];
      for (let g of groups) {
        const ref = doc(db, "surveyGroups", g);
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const data = snap.data();
          if (data.count < perGroupLimit) {
            available.push({ ref, data });
          }
        }
      }

      if (available.length === 0) {
        document.getElementById("message").innerText = "æ„Ÿè¬åƒèˆ‡ï¼Œæœ¬ç ”ç©¶å·²é¡æ»¿ï¼";
        return;
      }

      // éš¨æ©ŸæŒ‘ä¸€çµ„
      const choice = available[Math.floor(Math.random() * available.length)];
      await updateDoc(choice.ref, {
        count: choice.data.count + 1
      });

      // è·³è½‰
      window.location.href = choice.data.url;
    }

    // â³ å€’æ•¸ 3 ç§’ï¼Œæ‰çœŸæ­£è§¸ç™¼ assignGroup()
    let count = 3;
    const interval = setInterval(() => {
      document.getElementById("message").innerText = `å€’æ•¸ ${count} ç§’å¾Œè‡ªå‹•åˆ†æ´¾â€¦`;
      count--;
      if (count < 0) {
        clearInterval(interval);
        assignGroup();
      }
    }, 1000);
  </script>
</body>
